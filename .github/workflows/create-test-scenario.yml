name: AI Test Automation Pipeline

on:
  workflow_dispatch:
    inputs:
      test_description:
        description: 'Test description in plain English'
        required: true
        type: string
      openai_api_key:
        description: 'OpenAI API Key'
        required: true
        type: string
      slack_webhook_url:
        description: 'Slack Webhook URL for notifications'
        required: false
        type: string
      run_tests:
        description: 'Run tests in browser (headless/headed)'
        required: false
        type: choice
        default: 'headless'
        options:
          - 'headless'
          - 'headed'
          - 'no'
      enable_slack:
        description: 'Enable Slack notifications'
        required: false
        type: boolean
        default: true

env:
  TEST_DESCRIPTION: ${{ inputs.test_description }}
  OPENAI_API_KEY: ${{ inputs.openai_api_key }}
  SLACK_WEBHOOK_URL: ${{ inputs.slack_webhook_url }}
  RUN_TESTS: ${{ inputs.run_tests }}
  ENABLE_SLACK: ${{ inputs.enable_slack }}

jobs:
  create-test-scenario:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install backend dependencies
      run: |
        cd backend
        npm ci

    - name: Build backend
      run: |
        cd backend
        npm run build

    - name: Start backend server
      run: |
        cd backend
        DB_DISABLED=true NODE_ENV=development PORT=3001 npm start &
        echo "Backend server starting..."
        
        # Wait for backend to be ready
        for i in {1..30}; do
          if curl -f http://localhost:3001/health >/dev/null 2>&1; then
            echo "‚úÖ Backend is ready!"
            break
          fi
          echo "Waiting for backend... ($i/30)"
          sleep 2
        done

    - name: Send workflow start notification to Slack
      if: env.ENABLE_SLACK == 'true' && env.SLACK_WEBHOOK_URL != ''
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data "{\"text\":\"üöÄ *AI Test Automation Pipeline Started*\n\n*Test Description:* ${{ env.TEST_DESCRIPTION }}\n*Triggered by:* ${{ github.actor }}\n*Workflow Run:* ${{ github.run_id }}\n*Repository:* ${{ github.repository }}\"}" \
        ${{ env.SLACK_WEBHOOK_URL }}

    - name: Generate and create complete test scenario
      run: |
        echo "üöÄ Generating and creating complete test scenario from: ${{ env.TEST_DESCRIPTION }}" && echo "Test description length: ${#TEST_DESCRIPTION}" && if [ -z "${{ env.TEST_DESCRIPTION }}" ]; then echo "‚ùå No test description provided"; echo "Raw env value: '${{ env.TEST_DESCRIPTION }}'"; exit 1; fi && echo "‚úÖ Test description provided" && echo "Calling API to parse steps..." && STEPS_RESPONSE=$(curl -X POST http://localhost:3001/api/nlp/parse -H "Content-Type: application/json" -d "{\"text\": \"${{ env.TEST_DESCRIPTION }}\"}" -w "\n%{http_code}") && HTTP_CODE=$(echo "$STEPS_RESPONSE" | tail -n1) && STEPS_BODY=$(echo "$STEPS_RESPONSE" | sed '$d') && echo "Steps HTTP Code: $HTTP_CODE" && echo "Steps Response Length: ${#STEPS_BODY}" && echo "Success: $(echo "$STEPS_BODY" | grep -o '"success":true' || echo 'false')" && if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then echo "‚úÖ Test steps generated successfully!"; echo "Creating payload..." && echo "$STEPS_BODY" | jq -c '{steps: .steps, language: "typescript"}' > /tmp/steps.json && echo "Payload created:" && cat /tmp/steps.json && echo "" && echo "Calling API to generate code..." && CODE_RESPONSE=$(curl -X POST http://localhost:3001/api/nlp/generate-code -H "Content-Type: application/json" -d @/tmp/steps.json -w "\n%{http_code}") && CODE_HTTP_CODE=$(echo "$CODE_RESPONSE" | tail -n1) && CODE_BODY=$(echo "$CODE_RESPONSE" | sed '$d') && echo "Code HTTP Code: $CODE_HTTP_CODE" && echo "Code Response Length: ${#CODE_BODY}" && echo "Code Success: $(echo "$CODE_BODY" | grep -o '"success":true' || echo 'false')" && if [ "$CODE_HTTP_CODE" -eq 200 ] || [ "$CODE_HTTP_CODE" -eq 201 ]; then echo "‚úÖ Test code generated successfully!"; echo "Creating test scenario files..." && mkdir -p test-scenarios && echo "Extracting test steps..." && TEST_STEPS=$(echo "$STEPS_BODY" | jq -r '.steps // .parsedSteps // "No steps generated"' 2>/dev/null || echo "No steps generated - parsing failed") && echo "Creating comprehensive test scenario file..." && echo "# Test Scenario" > test-scenarios/test-scenario-${{ github.run_id }}.md && echo "Generated on: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> test-scenarios/test-scenario-${{ github.run_id }}.md && echo "Triggered by: ${{ github.actor }}" >> test-scenarios/test-scenario-${{ github.run_id }}.md && echo "Workflow Run: ${{ github.run_id }}" >> test-scenarios/test-scenario-${{ github.run_id }}.md && echo "" >> test-scenarios/test-scenario-${{ github.run_id }}.md && echo "## Test Description" >> test-scenarios/test-scenario-${{ github.run_id }}.md && echo "${{ env.TEST_DESCRIPTION }}" >> test-scenarios/test-scenario-${{ github.run_id }}.md && echo "" >> test-scenarios/test-scenario-${{ github.run_id }}.md && echo "## Generated Test Steps" >> test-scenarios/test-scenario-${{ github.run_id }}.md && echo "\`\`\`json" >> test-scenarios/test-scenario-${{ github.run_id }}.md && echo "$STEPS_BODY" >> test-scenarios/test-scenario-${{ github.run_id }}.md && echo "\`\`\`" >> test-scenarios/test-scenario-${{ github.run_id }}.md && echo "" >> test-scenarios/test-scenario-${{ github.run_id }}.md && echo "## Generated Test Code Response" >> test-scenarios/test-scenario-${{ github.run_id }}.md && echo "\`\`\`json" >> test-scenarios/test-scenario-${{ github.run_id }}.md && echo "$CODE_BODY" >> test-scenarios/test-scenario-${{ github.run_id }}.md && echo "\`\`\`" >> test-scenarios/test-scenario-${{ github.run_id }}.md && echo "" >> test-scenarios/test-scenario-${{ github.run_id }}.md && echo "## Test Steps (Human Readable)" >> test-scenarios/test-scenario-${{ github.run_id }}.md && echo "$TEST_STEPS" >> test-scenarios/test-scenario-${{ github.run_id }}.md && echo "" >> test-scenarios/test-scenario-${{ github.run_id }}.md && echo "## Usage Instructions" >> test-scenarios/test-scenario-${{ github.run_id }}.md && echo "1. Extract the code from the JSON response above" >> test-scenarios/test-scenario-${{ github.run_id }}.md && echo "2. Save it as a .js file in your test project" >> test-scenarios/test-scenario-${{ github.run_id }}.md && echo "3. Run with: npx playwright test your-test-file.js" >> test-scenarios/test-scenario-${{ github.run_id }}.md && echo "Creating raw response file..." && echo "$CODE_BODY" > test-scenarios/code-response-${{ github.run_id }}.json && echo "Creating steps file..." && echo "$TEST_STEPS" > test-scenarios/test-steps-${{ github.run_id }}.txt && echo "‚úÖ Test scenario files created successfully!" && echo "Files created:" && ls -la test-scenarios/ && echo "Main file size:" && wc -c test-scenarios/test-scenario-${{ github.run_id }}.md; else echo "‚ùå Failed to generate test code"; echo "Raw code response: $CODE_RESPONSE"; exit 1; fi; else echo "‚ùå Failed to generate test steps"; echo "Raw steps response: $STEPS_RESPONSE"; echo "Debug: TEST_DESCRIPTION value: '${{ env.TEST_DESCRIPTION }}'"; echo "Debug: TEST_DESCRIPTION length: ${#TEST_DESCRIPTION}"; exit 1; fi && rm -f /tmp/steps.json

    - name: Create test in platform and execute
      if: env.RUN_TESTS != 'no'
      run: |
        echo "üöÄ Creating test in platform and executing..." && \
        echo "üìù Creating test payload..." && \
        TEST_NAME="GitHub Action Test - ${{ github.run_id }}" && \
        TEST_PAYLOAD=$(cat <<EOF
        {
          "name": "$TEST_NAME",
          "description": "${{ env.TEST_DESCRIPTION }}",
          "steps": $(cat test-scenarios/code-response-${{ github.run_id }}.json | jq '.parsedSteps // .steps // []'),
          "generatedCode": $(cat test-scenarios/code-response-${{ github.run_id }}.json | jq '.generatedCode.code // ""'),
          "language": "typescript"
        }
        EOF
        ) && \
        echo "Creating test in platform..." && \
        CREATE_RESPONSE=$(curl -X POST http://localhost:3001/api/tests -H "Content-Type: application/json" -d "$TEST_PAYLOAD" -w "\n%{http_code}") && \
        CREATE_HTTP_CODE=$(echo "$CREATE_RESPONSE" | tail -n1) && \
        CREATE_BODY=$(echo "$CREATE_RESPONSE" | sed '$d') && \
        echo "Create Test HTTP Code: $CREATE_HTTP_CODE" && \
        if [ "$CREATE_HTTP_CODE" -eq 201 ]; then \
          echo "‚úÖ Test created successfully!" && \
          TEST_ID=$(echo "$CREATE_BODY" | jq -r '.test.id // "unknown"') && \
          echo "Test ID: $TEST_ID" && \
          echo "üöÄ Executing test..." && \
          EXEC_PAYLOAD=$(cat <<EOF
          {
            "headless": ${{ env.RUN_TESTS == 'headless' }},
            "slowMoMs": 1000,
            "enableSlackNotifications": ${{ env.ENABLE_SLACK == 'true' }}
          }
          EOF
          ) && \
          EXEC_RESPONSE=$(curl -X POST http://localhost:3001/api/execution/$TEST_ID/run -H "Content-Type: application/json" -d "$EXEC_PAYLOAD" -w "\n%{http_code}") && \
          EXEC_HTTP_CODE=$(echo "$EXEC_RESPONSE" | tail -n1) && \
          EXEC_BODY=$(echo "$EXEC_RESPONSE" | sed '$d') && \
          echo "Execution HTTP Code: $EXEC_HTTP_CODE" && \
          if [ "$EXEC_HTTP_CODE" -eq 200 ]; then \
            echo "‚úÖ Test executed successfully!" && \
            echo "Execution Result:" && \
            echo "$EXEC_BODY" | jq '.' && \
            EXECUTION_ID=$(echo "$EXEC_BODY" | jq -r '.executionId // "unknown"') && \
            TEST_STATUS=$(echo "$EXEC_BODY" | jq -r '.status // "unknown"') && \
            echo "EXECUTION_ID=$EXECUTION_ID" >> $GITHUB_ENV && \
            echo "TEST_STATUS=$TEST_STATUS" >> $GITHUB_ENV && \
            echo "TEST_ID=$TEST_ID" >> $GITHUB_ENV; \
          else \
            echo "‚ùå Test execution failed" && \
            echo "Raw execution response: $EXEC_RESPONSE" && \
            exit 1; \
          fi; \
        else \
          echo "‚ùå Failed to create test" && \
          echo "Raw create response: $CREATE_RESPONSE" && \
          exit 1; \
        fi

    - name: Install Playwright and dependencies
      if: env.RUN_TESTS != 'no'
      run: |
        npm install -g playwright
        npx playwright install chromium
        npx playwright install-deps

    - name: Extract and run test code
      if: env.RUN_TESTS != 'no'
      run: |
        echo "üöÄ Extracting and running test code..." && \
        if [ "${{ env.RUN_TESTS }}" = "no" ]; then \
          echo "‚è≠Ô∏è Skipping test execution as requested"; \
          exit 0; \
        fi && \
        echo "üìù Extracting test code from JSON response..." && \
        TEST_CODE=$(python3 extract_code.py test-scenarios/code-response-${{ github.run_id }}.json 2>/dev/null || echo "No code found - parsing failed") && \
        if [ "$TEST_CODE" = "No code found" ] || [ "$TEST_CODE" = "null" ]; then \
          echo "‚ùå No test code found in response"; \
          exit 1; \
        fi && \
        echo "‚úÖ Test code extracted successfully!" && \
        echo "üíæ Saving test code to file..." && \
        echo "$TEST_CODE" > test-scenarios/generated-test-${{ github.run_id }}.js && \
        echo "üîß Setting up test environment..." && \
        mkdir -p test-runner && \
        cd test-runner && \
        npm init -y && \
        npm install playwright && \
        echo "üìã Creating test configuration..." && \
        echo "module.exports = { use: { headless: ${{ env.RUN_TESTS == 'headless' }} } };" > playwright.config.js && \
        echo "üöÄ Running test..." && \
        if [ "${{ env.RUN_TESTS }}" = "headed" ]; then \
          echo "üñ•Ô∏è Running test with browser visible..." && \
          npx playwright test ../test-scenarios/generated-test-${{ github.run_id }}.js --headed; \
        else \
          echo "üëª Running test headlessly..." && \
          npx playwright test ../test-scenarios/generated-test-${{ github.run_id }}.js; \
        fi && \
        echo "‚úÖ Test execution completed!" && \
        echo "üìä Test results:" && \
        ls -la test-results/ 2>/dev/null || echo "No test results directory found" && \
        echo "üì∏ Screenshots:" && \
        ls -la test-results/screenshots/ 2>/dev/null || echo "No screenshots found" && \
        echo "üé• Videos:" && \
        ls -la test-results/videos/ 2>/dev/null || echo "No videos found"

    - name: Upload test scenarios
      uses: actions/upload-artifact@v4
      with:
        name: test-scenarios-${{ github.run_id }}
        path: test-scenarios/
        retention-days: 30

    - name: Upload test results
      if: env.RUN_TESTS != 'no'
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ github.run_id }}
        path: test-runner/test-results/
        retention-days: 30

    - name: Send workflow completion notification to Slack
      if: env.ENABLE_SLACK == 'true' && env.SLACK_WEBHOOK_URL != ''
      run: |
        if [ "${{ env.RUN_TESTS }}" != "no" ] && [ -n "${{ env.TEST_STATUS }}" ]; then
          STATUS_EMOJI="‚úÖ"
          STATUS_TEXT="SUCCESS"
          if [ "${{ env.TEST_STATUS }}" != "passed" ]; then
            STATUS_EMOJI="‚ùå"
            STATUS_TEXT="FAILED"
          fi
          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\"$STATUS_EMOJI *AI Test Automation Pipeline Completed*\n\n*Test Description:* ${{ env.TEST_DESCRIPTION }}\n*Status:* $STATUS_TEXT\n*Test ID:* ${{ env.TEST_ID }}\n*Execution ID:* ${{ env.EXECUTION_ID }}\n*Triggered by:* ${{ github.actor }}\n*Workflow Run:* ${{ github.run_id }}\n*Repository:* ${{ github.repository }}\n\nüìÅ *Artifacts Available:*\n‚Ä¢ Test scenario report\n‚Ä¢ Generated test code\n‚Ä¢ Test execution results (if executed)\"}" \
          ${{ env.SLACK_WEBHOOK_URL }}
        else
          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\"‚úÖ *AI Test Automation Pipeline Completed*\n\n*Test Description:* ${{ env.TEST_DESCRIPTION }}\n*Status:* Test code generated successfully\n*Triggered by:* ${{ github.actor }}\n*Workflow Run:* ${{ github.run_id }}\n*Repository:* ${{ github.repository }}\n\nüìÅ *Artifacts Available:*\n‚Ä¢ Test scenario report\n‚Ä¢ Generated test code\n‚Ä¢ Ready for manual execution\"}" \
          ${{ env.SLACK_WEBHOOK_URL }}
        fi

    - name: Comment on workflow
      run: |
        echo "‚úÖ AI Test Automation Pipeline completed successfully!"
        echo ""
        echo "üìä Pipeline Summary:"
        echo "   ‚Ä¢ Natural language processing: ‚úÖ"
        echo "   ‚Ä¢ Test code generation: ‚úÖ"
        echo "   ‚Ä¢ Test creation in platform: ‚úÖ"
        if [ "${{ env.RUN_TESTS }}" != "no" ]; then
          echo "   ‚Ä¢ Test execution: ‚úÖ"
          echo "   ‚Ä¢ Slack notifications: ‚úÖ"
        fi
        echo ""
        echo "üìÅ Files uploaded as artifacts:"
        echo "   - test-scenario-${{ github.run_id }}.md (comprehensive report)"
        echo "   - code-response-${{ github.run_id }}.json (raw code response)"
        echo "   - test-steps-${{ github.run_id }}.txt (human readable steps)"
        if [ "${{ env.RUN_TESTS }}" != "no" ]; then
          echo "   - test-results-${{ github.run_id }} (test execution results)"
          echo "   - generated-test-${{ github.run_id }}.js (executable test file)"
        fi
        echo ""
        echo "üéØ Next steps:"
        echo "   1. Download the artifacts from this workflow run"
        if [ "${{ env.RUN_TESTS }}" != "no" ]; then
          echo "   2. ‚úÖ Tests were executed automatically!"
          echo "   3. Check test-results artifact for screenshots/videos"
          echo "   4. Use generated-test-${{ github.run_id }}.js for future runs"
          echo "   5. Check Slack for detailed execution notifications"
        else
          echo "   2. Extract the test code from the JSON response"
          echo "   3. Save as a .js file in your test project"
          echo "   4. Run with: npx playwright test your-test-file.js"
        fi
        echo ""
        echo "üîó Platform Integration:"
        echo "   ‚Ä¢ Test created in platform with ID: ${{ env.TEST_ID }}"
        echo "   ‚Ä¢ Execution ID: ${{ env.EXECUTION_ID }}"
        echo "   ‚Ä¢ Status: ${{ env.TEST_STATUS }}"